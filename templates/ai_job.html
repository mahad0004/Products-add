{% extends "base.html" %}

{% block title %}AI Job #{{ ai_job_id }} - Shopify Automation{% endblock %}

{% block content %}
<h1 style="color: #ff00ff; font-size: 36px; margin-bottom: 30px;">ü§ñ AI Job #{{ ai_job_id }}</h1>

<!-- AI Job Info Card -->
<div class="card" style="margin-bottom: 30px;">
    <h2 class="card-title">Job Information</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
        <div>
            <div style="color: #888; font-size: 14px;">Status</div>
            <div style="font-size: 20px; color: #00ffff;" id="jobStatus">Loading...</div>
        </div>
        <div>
            <div style="color: #888; font-size: 14px;">AI Products Created</div>
            <div style="font-size: 20px; color: #00ffff;" id="aiProductsCreated">0</div>
        </div>
        <div>
            <div style="color: #888; font-size: 14px;">Products Pushed</div>
            <div style="font-size: 20px; color: #00ff88;" id="productsPushed">0</div>
        </div>
        <div>
            <div style="color: #888; font-size: 14px;">Created At</div>
            <div style="font-size: 16px; color: #888;" id="createdAt">-</div>
        </div>
    </div>
</div>

<!-- Push Progress Card -->
<div class="card" style="margin-bottom: 30px;" id="progressCard" style="display: none;">
    <h2 class="card-title">üöÄ Pushing to Shopify</h2>
    <div id="pushProgress" style="margin-top: 20px;">
        <div style="background: rgba(0,255,255,0.1); border-radius: 10px; height: 30px; overflow: hidden; margin-bottom: 15px;">
            <div id="progressBar" style="background: linear-gradient(90deg, #00ffff, #ff00ff); height: 100%; width: 0%; transition: width 0.3s;"></div>
        </div>
        <div id="progressText" style="text-align: center; font-size: 16px; color: #00ffff;">Ready to push...</div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div style="text-align: center;">
        <div class="spinner" style="width: 80px; height: 80px; border: 8px solid rgba(0,255,255,0.1); border-top: 8px solid #00ffff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 30px;"></div>
        <h2 style="color: #00ffff; margin-bottom: 10px;">ü§ñ Creating AI Products & Pushing to Shopify...</h2>
        <div id="loadingProgress" style="color: #888; font-size: 18px;">Processing products...</div>
        <div id="loadingCount" style="color: #ff00ff; font-size: 24px; margin-top: 15px; font-weight: bold;">0 / 30</div>
        <div id="loadingPushed" style="color: #00ff88; font-size: 18px; margin-top: 10px;">Pushed to Shopify: 0</div>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.product-card-new {
    animation: slideIn 0.5s ease-out;
}
</style>

<!-- AI Products List -->
<div class="card">
    <h2 class="card-title">AI Products (<span id="productsCount">0</span>)</h2>
    <div id="productsLoader" class="loader"></div>
    <div id="productsContainer" style="display: none;">
        <div id="productsList"></div>
    </div>
    <div id="productsEmpty" style="display: none; text-align: center; padding: 40px; color: #888;">
        No AI products found for this job.
    </div>
</div>

<div style="margin-top: 30px;">
    <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const aiJobId = {{ ai_job_id }};
    let pushStarted = false;
    let aiProductIds = [];
    let lastProductCount = 0;
    let sourceJobTotalProducts = 30; // Will be fetched from API
    let isJobRunning = false;
    let pollInterval = null;
    let currentPushStatus = 'not_started'; // Track push status from database

    // Load AI job details
    async function loadAIJob() {
        try {
            const response = await fetch('/api/ai-jobs');
            const data = await response.json();

            const aiJob = data.ai_jobs.find(j => j.id === aiJobId);
            if (!aiJob) {
                showAlert('AI Job not found', 'error');
                return;
            }

            // Update job info
            const status = aiJob.status.toUpperCase();
            document.getElementById('jobStatus').textContent = status;
            document.getElementById('aiProductsCreated').textContent = aiJob.ai_products_created || 0;
            document.getElementById('productsPushed').textContent = aiJob.products_pushed || 0;
            document.getElementById('createdAt').textContent = formatDate(aiJob.created_at);

            // Track push status from database
            currentPushStatus = aiJob.push_status || 'not_started';

            // Check if job is running
            isJobRunning = (status === 'RUNNING');

            // Show loading overlay if job is running and no products yet
            if (isJobRunning) {
                document.getElementById('loadingOverlay').style.display = 'flex';
                startPolling();
            } else {
                document.getElementById('loadingOverlay').style.display = 'none';
                stopPolling();
            }

            // Get source job total products
            if (aiJob.source_job_id) {
                const jobsResponse = await fetch('/api/jobs');
                const jobsData = await jobsResponse.json();
                const sourceJob = jobsData.jobs.find(j => j.id === aiJob.source_job_id);
                if (sourceJob) {
                    sourceJobTotalProducts = sourceJob.total_products || 30;
                }
            }

            // Load AI products
            await loadAIProducts();

        } catch (error) {
            console.error('Error loading AI job:', error);
            showAlert('Error loading AI job: ' + error.message, 'error');
        }
    }

    // Load AI products from this job
    async function loadAIProducts() {
        try {
            const response = await fetch(`/api/ai-products?ai_job_id=${aiJobId}&limit=1000`);
            const data = await response.json();

            // Get AI products filtered by this specific AI job
            const aiProducts = data.products;

            document.getElementById('productsLoader').style.display = 'none';

            // Update products count
            const currentCount = aiProducts ? aiProducts.length : 0;
            document.getElementById('productsCount').textContent = currentCount;

            // Update loading overlay if job is running
            if (isJobRunning) {
                const pushedCount = aiProducts.filter(p => p.shopify_product_id).length;
                document.getElementById('loadingCount').textContent = `${currentCount} / ${sourceJobTotalProducts}`;
                document.getElementById('loadingPushed').textContent = `Pushed to Shopify: ${pushedCount}`;

                if (currentCount > 0) {
                    const lastProduct = aiProducts[aiProducts.length - 1];
                    const status = lastProduct.shopify_product_id ? '‚úÖ Pushed' : '‚è≥ Pushing...';
                    document.getElementById('loadingProgress').textContent = `${status} ${lastProduct.title.substring(0, 60)}...`;
                }

                // Hide loading overlay if job completed
                if (currentCount >= sourceJobTotalProducts) {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    isJobRunning = false;
                    stopPolling();
                }
            }

            if (!aiProducts || aiProducts.length === 0) {
                if (!isJobRunning) {
                    document.getElementById('productsEmpty').style.display = 'block';
                }
                return;
            }

            document.getElementById('productsContainer').style.display = 'block';
            document.getElementById('productsEmpty').style.display = 'none';

            // Store product IDs for pushing
            aiProductIds = aiProducts.map(p => p.id);

            // Display products (only add new ones)
            const productsList = document.getElementById('productsList');

            // If this is a full refresh or first load, clear and re-render
            if (currentCount < lastProductCount || lastProductCount === 0) {
                productsList.innerHTML = '';
                lastProductCount = 0;
            }

            // Add only new products
            for (let i = lastProductCount; i < aiProducts.length; i++) {
                const product = aiProducts[i];
                addProductCard(product);
            }

            lastProductCount = currentCount;

            // Since the new workflow pushes immediately after creating, we don't need separate auto-push
            // The push happens automatically during AI job processing
            // Just show completed status if push_status is completed
            if (currentPushStatus === 'completed') {
                console.log('Push completed during AI job processing');
                pushStarted = true;
                document.getElementById('progressCard').style.display = 'block';
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressText').textContent = '‚úÖ All products created and pushed to Shopify!';
                document.getElementById('progressText').style.color = '#00ff88';
            }

        } catch (error) {
            console.error('Error loading AI products:', error);
            document.getElementById('productsLoader').style.display = 'none';
        }
    }

    // Add a single product card to the list
    function addProductCard(product) {
        const productsList = document.getElementById('productsList');
        const productCard = document.createElement('div');
        productCard.className = 'product-card-new';
        productCard.style.cssText = 'background: rgba(255,255,255,0.03); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,255,255,0.1);';

        const statusColor = product.status === 'pushed' ? '#00ff88' :
                           product.status === 'pending' ? '#ffc800' : '#888';

        productCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <div style="font-size: 16px; color: #00ffff; margin-bottom: 5px;">${product.title}</div>
                    <div style="font-size: 14px; color: #888;">Status: <span style="color: ${statusColor}">${product.status}</span></div>
                </div>
                <div>
                    ${product.shopify_product_id ?
                        `<span style="color: #00ff88;">‚úì Pushed (${product.shopify_product_id})</span>` :
                        `<span style="color: #ffc800;">‚è≥ Not pushed</span>`
                    }
                </div>
            </div>
        `;
        productsList.appendChild(productCard);
    }

    // Start polling for updates
    function startPolling() {
        if (pollInterval) return; // Already polling

        pollInterval = setInterval(async () => {
            await loadAIJob();
        }, 2000); // Poll every 2 seconds
    }

    // Stop polling
    function stopPolling() {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }

    // Start pushing products to Shopify
    async function startPush() {
        if (pushStarted || aiProductIds.length === 0) return;

        // Check database status one more time before starting
        if (currentPushStatus !== 'not_started') {
            console.log('Push already started or completed, skipping...');
            return;
        }

        pushStarted = true;
        document.getElementById('progressCard').style.display = 'block';

        try {
            const response = await fetch('/api/ai-products/bulk-action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'push_to_shopify',
                    product_ids: aiProductIds,
                    ai_job_id: aiJobId  // Pass AI job ID for tracking
                })
            });

            const data = await response.json();

            if (!response.ok) {
                if (data.status === 'already_running') {
                    // Push already in progress, just monitor it
                    console.log('Push already running, monitoring...');
                    monitorProgress();
                } else {
                    showAlert('Failed to start push: ' + data.error, 'error');
                }
                return;
            }

            // Monitor progress
            monitorProgress();

        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    // Monitor push progress
    function monitorProgress() {
        const interval = setInterval(async () => {
            try {
                // Get progress from API
                const response = await fetch('/api/ai-push-progress');
                const progress = await response.json();

                const percent = progress.total > 0 ? Math.round((progress.current / progress.total) * 100) : 0;

                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressText').textContent = progress.message || 'Processing...';

                // Also reload AI job to get updated products_pushed count from database
                await loadAIJob();

                // Reload products list to show real-time updates
                await loadAIProducts();

                if (progress.status === 'completed') {
                    clearInterval(interval);
                    document.getElementById('progressText').textContent = '‚úÖ ' + progress.message;
                    document.getElementById('progressText').style.color = '#00ff88';

                    // Final reload to show all updated products
                    setTimeout(() => {
                        loadAIProducts();
                        loadAIJob();
                    }, 1000);
                } else if (progress.status === 'error' || progress.status === 'cancelled') {
                    clearInterval(interval);
                    document.getElementById('progressText').textContent = '‚ùå ' + progress.message;
                    document.getElementById('progressText').style.color = '#ff4444';
                }

            } catch (error) {
                console.error('Error monitoring progress:', error);
                clearInterval(interval);
            }
        }, 1000); // Poll every 1 second for real-time updates
    }

    // Load on page load
    loadAIJob();
</script>
{% endblock %}
